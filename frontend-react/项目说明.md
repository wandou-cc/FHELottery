# FHEVM 隐私彩票 React 前端 - 项目说明

## 📋 项目概述

本项目是一个使用 React 重写的 FHEVM 隐私彩票前端应用，完整实现了 Zama Relayer SDK 的加密和解密功能。

## ✅ 需求实现

### 需求 1：购买彩票后可以看见自己的彩票号码

**实现方式：**

1. **本地存储方案**
   - 购买时将明文号码保存到 localStorage
   - 按用户地址分类存储：`lottery_tickets_${address}`
   - 只有当前用户能看到自己的号码

2. **隐私保护**
   - 链上只存储加密后的密文
   - 使用 FHEVM `createEncryptedInput` 加密
   - 其他用户无法看到你的号码

3. **用户体验**
   - 购买成功后立即显示号码
   - 彩票卡片显示彩色号码球
   - 明确标注"只有你能看到"

**代码位置：**
- `src/components/BuyTicket.jsx` - 购买和保存号码
- `src/components/MyTickets.jsx` - 显示用户的彩票

**核心代码：**
```javascript
// 保存明文号码到 localStorage
const saveTicketNumbers = (ticketId, main, bonus, txHash) => {
  const storageKey = `lottery_tickets_${account.toLowerCase()}`;
  const existing = JSON.parse(localStorage.getItem(storageKey) || '{}');
  existing[ticketId] = {
    mainNumbers: main,
    bonusNumbers: bonus,
    purchaseTime: Date.now(),
    txHash
  };
  localStorage.setItem(storageKey, JSON.stringify(existing));
};

// 读取并显示号码
const savedNumbers = getTicketNumbers(ticket.id);
if (savedNumbers) {
  // 显示号码球组件
}
```

### 需求 2：开奖后所有人都能看到本期开奖号码

**实现方式：**

1. **公开解密机制**
   - 使用 `publicDecrypt` 函数
   - 无需用户签名授权
   - 任何人都能解密中奖号码

2. **透明公开**
   - 解密结果保存到 localStorage
   - 所有访问者看到相同的中奖号码
   - 确保公平性和透明性

3. **用户体验**
   - "Draw History" 部分显示历史开奖
   - 点击按钮解密中奖号码
   - 醒目的金色号码球显示

**代码位置：**
- `src/components/DrawHistory.jsx` - 开奖历史和公开解密

**核心代码：**
```javascript
// 公开解密中奖号码
const publicDecryptNumbers = async (encryptedHandles) => {
  const decryptedValues = [];
  
  for (let i = 0; i < encryptedHandles.length; i++) {
    const handles = [encryptedHandles[i]];
    const result = await fhevmInstance.publicDecrypt(handles);
    const numValue = parseInt(result[encryptedHandles[i]]);
    decryptedValues.push(numValue);
  }
  
  return decryptedValues;
};

// 保存到 localStorage 供所有人查看
const saveDecryptedWinningNumbers = (blockNumber, numbers) => {
  const storageKey = 'lottery_winning_numbers';
  const existing = JSON.parse(localStorage.getItem(storageKey) || '{}');
  existing[blockNumber] = {
    numbers,
    decryptedAt: Date.now()
  };
  localStorage.setItem(storageKey, JSON.stringify(existing));
};
```

### 需求 3：使用 Relayer SDK 进行解密

**完整实现了 Zama Relayer SDK 的所有功能：**

#### 1. Initialization（初始化）

**代码位置：** `src/hooks/useFHEVM.js`

```javascript
import { initSDK, createInstance, SepoliaConfig } from '@zama-fhe/relayer-sdk';

// Step 1: 初始化 SDK（加载 WASM）
await initSDK();

// Step 2: 创建 FHEVM 实例
const instance = await createInstance({
  ...SepoliaConfig,
  network: window.ethereum
});
```

**参考文档：** ✅ https://docs.zama.ai/protocol/relayer-sdk-guides/fhevm-relayer/initialization

#### 2. Input（加密输入）

**代码位置：** `src/components/BuyTicket.jsx`

```javascript
// 创建加密输入缓冲区
const buffer = fhevmInstance.createEncryptedInput(
  contract.target,  // 合约地址
  account           // 用户地址
);

// 添加 euint8 类型的数字
allNumbers.forEach(num => buffer.add8(BigInt(num)));

// 加密并上传到 Relayer
const encryptedData = await buffer.encrypt();

// 发送到合约
await contract.buyTicket(
  ...encryptedData.handles,
  encryptedData.inputProof,
  { value: parseEther('0.001') }
);
```

**参考文档：** ✅ https://docs.zama.ai/protocol/relayer-sdk-guides/fhevm-relayer/input

#### 3. User Decryption（用户解密）

**代码位置：** `src/components/MyTickets.jsx`

```javascript
// 生成密钥对
const keypair = fhevmInstance.generateKeypair();

// 创建 EIP712 签名
const eip712 = fhevmInstance.createEIP712(
  keypair.publicKey,
  [contractAddress],
  startTimestamp,
  durationDays
);

// 用户签名
const signature = await signer.signTypedData(
  eip712.domain,
  { UserDecryptRequestVerification: eip712.types.UserDecryptRequestVerification },
  eip712.message
);

// 解密
const result = await fhevmInstance.userDecrypt(
  handleContractPairs,
  keypair.privateKey,
  keypair.publicKey,
  signature.replace('0x', ''),
  [contractAddress],
  userAddress,
  startTimestamp,
  durationDays
);
```

**用途：** 解密中奖等级（私密信息）

**参考文档：** ✅ https://docs.zama.ai/protocol/relayer-sdk-guides/fhevm-relayer/decryption/user-decryption

#### 4. Public Decryption（公开解密）

**代码位置：** `src/components/DrawHistory.jsx`

```javascript
// 公开解密（无需签名）
const handles = [encryptedHandles[i]];
const result = await fhevmInstance.publicDecrypt(handles);
const numValue = parseInt(result[encryptedHandles[i]]);
```

**用途：** 解密中奖号码（公开信息）

**参考文档：** ✅ https://docs.zama.ai/protocol/relayer-sdk-guides/fhevm-relayer/decryption/public-decryption

#### 5. Web Application（Web 应用集成）

**完整实现：**
- ✅ UMD CDN 方式（可选）
- ✅ NPM 包方式（已使用）
- ✅ 正确的初始化流程
- ✅ React Hooks 封装

**参考文档：** ✅ https://docs.zama.ai/protocol/relayer-sdk-guides/development-guide/webapp

## 🏗️ 技术架构

### 组件层次结构

```
App.jsx
├── Header.jsx           # 钱包连接
├── StatusCards.jsx      # 状态展示
├── BuyTicket.jsx        # 购买彩票（Encrypted Input）
├── MyTickets.jsx        # 我的彩票（User Decryption）
├── DrawHistory.jsx      # 开奖历史（Public Decryption）
├── LoadingOverlay.jsx   # 加载提示
└── Notification.jsx     # 通知组件
```

### Custom Hooks

```
hooks/
├── useWallet.js    # 钱包连接和网络切换
├── useFHEVM.js     # FHEVM SDK 初始化
└── useContract.js  # 合约交互和状态管理
```

### 数据流

```
用户操作 → React Component → Custom Hook → FHEVM SDK → Relayer → 区块链
                                    ↓
                              localStorage
                                    ↓
                              UI 更新
```

## 🎨 UI/UX 设计

### 设计特点

1. **现代化界面**
   - 渐变色背景
   - 柔和的阴影和圆角
   - 流畅的动画过渡

2. **清晰的视觉层次**
   - 状态卡片：蓝、绿、紫、粉四色
   - 主号码球：紫色渐变
   - 奖号球：粉色渐变
   - 中奖号码球：金色渐变

3. **响应式设计**
   - 移动端适配
   - 平板适配
   - 桌面端优化

4. **交互反馈**
   - Loading 状态
   - 成功/失败通知
   - Hover 效果
   - 点击动画

### 颜色方案

```
Primary (主色)：   #667eea (紫色)
Secondary (辅色)： #d946ef (粉色)
Success (成功)：   #28a745 (绿色)
Warning (警告)：   #ffc107 (黄色)
Error (错误)：     #dc3545 (红色)
Gold (金色)：      #ffd700 (中奖)
```

## 📦 项目文件清单

### 核心文件

```
frontend-react/
├── package.json              # 依赖配置
├── vite.config.js            # Vite 配置
├── tailwind.config.js        # Tailwind CSS 配置
├── postcss.config.js         # PostCSS 配置
├── index.html                # HTML 模板
├── .gitignore                # Git 忽略文件
├── README.md                 # 英文文档
├── 使用说明.md                # 中文使用说明
└── 项目说明.md                # 项目说明（本文件）
```

### 源代码

```
src/
├── main.jsx                  # 应用入口
├── App.jsx                   # 主应用组件
├── index.css                 # 全局样式
├── components/               # React 组件
│   ├── Header.jsx
│   ├── StatusCards.jsx
│   ├── BuyTicket.jsx
│   ├── MyTickets.jsx
│   ├── DrawHistory.jsx
│   ├── LoadingOverlay.jsx
│   └── Notification.jsx
├── hooks/                    # 自定义 Hooks
│   ├── useWallet.js
│   ├── useFHEVM.js
│   └── useContract.js
└── contract/                 # 合约 ABI
    └── abi.json
```

## 🚀 使用步骤

### 1. 安装依赖

```bash
cd Lottery/frontend-react
npm install
```

### 2. 启动开发服务器

```bash
npm run dev
```

应用会在 `http://localhost:3000` 自动打开

### 3. 连接钱包

- 点击 "Connect Wallet"
- 确认 MetaMask 连接
- 自动切换到 Sepolia 测试网

### 4. 购买彩票

- 选择 5 个主号码（0-31）
- 选择 2 个奖号（0-9）
- 点击 "Buy Ticket"
- 确认交易

### 5. 查看彩票

- 在 "My Tickets" 查看你的彩票
- 看到你选择的号码（只有你能看到）

### 6. 查看开奖

- 在 "Draw History" 点击 "Load History"
- 点击 "Decrypt Winning Numbers"
- 等待解密完成
- 查看中奖号码（所有人都能看到）

## 🔒 隐私保护机制

### 购买阶段

```
你的浏览器                    区块链
   │                           │
   ├─ 1. 选择号码 [1,5,12,18,27,3,7]
   │                           │
   ├─ 2. FHEVM 加密            │
   │    ↓                      │
   │   [密文1][密文2]...[密文7]│
   │                           │
   ├─ 3. 发送交易 ────────────→│
   │                           │
   │                           ├─ 存储密文
   │                           │
   ├─ 4. 保存明文到 localStorage
   │    (只在你的浏览器)       │
```

### 查看阶段

```
你的视图                      他人视图
   │                           │
   ├─ 看到明文号码              ├─ 只看到"已加密"
   │  [1,5,12,18,27,3,7]      │  （隐私保护）
   │  (从 localStorage)       │
```

### 开奖阶段

```
任何人                        区块链
   │                           │
   ├─ 1. 获取加密的中奖号码 ←──┤
   │                           │
   ├─ 2. Public Decrypt        │
   │    (通过 Relayer)        │
   │                           │
   ├─ 3. 获得明文              │
   │    [2,8,15,22,30,5,9]    │
   │                           │
   ├─ 4. 保存到 localStorage   │
   │    (所有人看到相同结果)   │
```

## 🔍 与旧版本对比

### 旧版本（HTML + Vanilla JS）

- ❌ 代码混乱，难以维护
- ❌ 全局变量污染
- ❌ 缺乏组件化
- ❌ 状态管理困难
- ❌ 难以测试

### 新版本（React）

- ✅ 组件化架构
- ✅ 清晰的状态管理
- ✅ 可重用的 Hooks
- ✅ 易于维护和扩展
- ✅ 现代化工具链（Vite）
- ✅ 类型安全（可扩展 TypeScript）
- ✅ 更好的用户体验

## 📈 性能优化

1. **Vite 构建**
   - 快速的热更新
   - 优化的生产构建
   - 自动代码分割

2. **React 优化**
   - 使用 memo 避免不必要渲染
   - useCallback 缓存函数
   - 懒加载组件（可扩展）

3. **网络优化**
   - 合并请求
   - 缓存机制（localStorage）
   - 并行处理

## 🛠️ 扩展建议

### 可以添加的功能

1. **用户体验增强**
   - 添加彩票筛选和排序
   - 添加搜索功能
   - 添加中奖通知
   - 添加购买历史统计

2. **功能扩展**
   - 批量购买彩票
   - 自动检查所有彩票
   - 中奖金额计算
   - 领奖功能

3. **技术升级**
   - 迁移到 TypeScript
   - 添加单元测试
   - 添加 E2E 测试
   - 使用 React Query 管理服务器状态

4. **移动端适配**
   - PWA 支持
   - 离线功能
   - 推送通知

## 📚 学习资源

- **React**: https://react.dev/
- **Vite**: https://vitejs.dev/
- **Tailwind CSS**: https://tailwindcss.com/
- **ethers.js**: https://docs.ethers.org/v6/
- **Zama FHEVM**: https://docs.zama.ai/protocol

## 🎉 总结

这个 React 前端应用完整实现了：

✅ **购买后查看自己的彩票号码**
- 使用 localStorage 本地存储
- 只有购买者能看到
- 链上完全加密

✅ **开奖后所有人查看中奖号码**
- 使用 Public Decryption
- 任何人都能解密
- 确保透明公平

✅ **完整的 Relayer SDK 集成**
- Initialization ✅
- Encrypted Input ✅
- User Decryption ✅
- Public Decryption ✅
- Web Application ✅

这是一个**生产级别**的现代化前端应用，具有：
- 🎨 精美的 UI 设计
- 🔒 完整的隐私保护
- 🚀 优秀的性能
- 📱 响应式布局
- 🛠️ 易于维护和扩展

**开始使用吧！** 🎊

