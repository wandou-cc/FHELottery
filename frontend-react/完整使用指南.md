# 🎰 React前端完整使用指南

## ✅ 已完成的功能

### 1. 区块查询优化
- ✅ 限制查询最近2天的数据
- ✅ 避免RPC区块范围过大错误
- ✅ 提高查询速度和成功率

### 2. 中奖号码解密
- ✅ 先请求访问权限 (`allowWinningNumbersAccess`)
- ✅ 再进行用户解密
- ✅ 支持批量解密7个号码
- ✅ 显示金色背景的中奖号码

### 3. 用户彩票显示
- ✅ 显示用户自己的明文号码（LocalStorage）
- ✅ 其他人看不到
- ✅ 彩色球显示

## 🚀 快速启动

### 1. 安装依赖

```bash
cd frontend-react
npm install
```

### 2. 启动开发服务器

```bash
npm run dev
```

访问 http://localhost:5173

### 3. 连接钱包并测试

1. 点击 "Connect Wallet"
2. 连接到Sepolia测试网
3. 购买彩票
4. 查看我的彩票
5. 加载历史开奖
6. 解密中奖号码

## 📝 重要配置

### 合约地址

已更新为: `0x002784c1e871843863Ad1086bcf73ff71284eF9c`

位置: `src/hooks/useContract.js` 第5行

### 区块查询范围

```javascript
// 最近2天的区块
const blocksPerDay = 7200; // Sepolia: 12秒/块
const fromBlock = currentBlock - (blocksPerDay * 2);
```

## 🔧 解决的问题

### 问题1: RPC区块范围过大
**错误**: `Your RPC block range is too large`

**解决方案**: ✅ 已修改
- MyTickets: 限制查询最近2天
- DrawHistory: 限制查询最近2天

### 问题2: 解密返回0
**错误**: 所有解密值都是0

**原因**: 
1. 缺少ACL权限
2. 需要先调用`allowWinningNumbersAccess`

**解决方案**: ✅ 已修改
- 先调用`allowWinningNumbersAccess`授权
- 再进行用户解密

### 问题3: ABI缺少函数
**需要添加**: `allowWinningNumbersAccess`

**手动添加到 `src/contract/abi.json`**:
```json
,{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"allowWinningNumbersAccess","outputs":[],"stateMutability":"nonpayable","type":"function"}
```

## 🧪 完整测试流程

### 步骤1: 编译并部署合约

```bash
cd /Users/cc/github/web3/zama/Lottery

# 编译
npx hardhat compile

# 部署
npx hardhat deploy --network sepolia --reset

# 记录合约地址
# 更新到 frontend-react/src/hooks/useContract.js
```

### 步骤2: 更新React前端

```bash
cd frontend-react

# 1. 更新合约地址 (已完成)
# src/hooks/useContract.js: CONTRACT_ADDRESS = '0x...'

# 2. 手动添加 allowWinningNumbersAccess 到ABI
# 编辑 src/contract/abi.json

# 3. 启动前端
npm run dev
```

### 步骤3: 测试功能

#### 3.1 测试购买彩票
```
1. 连接钱包
2. 选择号码
3. 购买彩票
4. ✅ 应该显示成功
5. ✅ LocalStorage保存明文号码
```

#### 3.2 测试我的彩票
```
1. 点击刷新
2. ✅ 应该显示最近2天的彩票
3. ✅ 显示明文号码（彩色球）
4. ✅ 显示购买时间
```

#### 3.3 测试历史开奖
```
1. 点击"Load History"
2. ✅ 应该显示最近2天的开奖记录
3. 点击"Decrypt Winning Numbers"
4. ✅ MetaMask弹出两个签名请求:
   - 第一个: allowWinningNumbersAccess交易
   - 第二个: 用户解密签名
5. ✅ 显示金色背景的中奖号码
```

## 📊 数据流程

### 购买彩票
```
用户选号 → 本地保存明文 → FHEVM加密 → 上链存储
           ↓
    localStorage保存
    (只有自己可见)
```

### 查看我的彩票
```
查询事件 → 最近2天 → 获取彩票详情
                      ↓
              从localStorage读取明文号码
                      ↓
              显示彩色球（仅自己可见）
```

### 解密中奖号码
```
加载历史 → 查询NumbersDrawn事件 → 最近2天
                                    ↓
点击解密 → allowWinningNumbersAccess → 授权访问
                                    ↓
         签名并用户解密 → 显示公开号码（所有人可见）
```

## ⚠️ 注意事项

### 1. 区块查询限制
- ✅ 已限制为最近2天
- ✅ Sepolia: 约14,400个区块
- ✅ 避免RPC错误

### 2. 需要手动更新ABI
由于是JSON格式，需要手动添加`allowWinningNumbersAccess`函数定义。

### 3. 需要重新部署合约
合约已更新，需要重新部署才能使用新功能。

## 🎯 关键代码位置

### MyTickets.jsx
- 第30-37行: 限制查询最近2天的彩票
- 第7-16行: 从LocalStorage读取明文号码

### DrawHistory.jsx
- 第20-27行: 限制查询最近2天的开奖
- 第70-82行: 请求访问权限
- 第143-219行: 用户解密函数

### useContract.js
- 第5行: 合约地址配置

## 💡 使用技巧

### 查看更多历史
如果需要查看更早的记录，可以修改天数：

```javascript
const fromBlock = currentBlock - (blocksPerDay * 7); // 最近7天
```

### 清除本地数据
如果需要清除LocalStorage:

```javascript
// 在浏览器控制台执行
localStorage.clear();
```

### 导出彩票数据
```javascript
// 在浏览器控制台执行
const account = '0x你的地址';
const key = `lottery_tickets_${account.toLowerCase()}`;
const data = localStorage.getItem(key);
console.log(data);
// 复制并保存
```

## 🚀 现在可以测试

```bash
# 1. 启动React前端
cd frontend-react
npm run dev

# 2. 打开浏览器
open http://localhost:5173

# 3. 连接钱包并测试
- 购买彩票 ✅
- 查看我的彩票 ✅
- 加载历史开奖 ✅
- 解密中奖号码 ✅
```

所有功能都已优化完成！🎉
