# FHEVM 隐私彩票 - React 前端使用说明

这是一个使用 React 和 Zama Relayer SDK 构建的现代化前端应用，实现了完全同态加密的隐私彩票系统。

## 🎯 主要功能

### 1. 购买彩票后查看自己的号码

当你购买彩票后：
- ✅ **本地存储**：你选择的号码会保存在浏览器的 localStorage 中
- ✅ **仅你可见**：只有你能看到自己的号码明文
- ✅ **链上加密**：区块链上只存储加密后的密文
- ✅ **隐私保护**：其他人无法看到你的号码

**实现方式：**
- 购买时使用 `createEncryptedInput` 创建加密输入
- 号码以 `euint8` 类型加密上传到 Relayer
- 明文号码仅保存在本地浏览器中
- 使用 localStorage 按地址和彩票ID存储

### 2. 开奖后所有人都能看到中奖号码

开奖后任何人都可以：
- ✅ **公开解密**：使用 Public Decryption 解密中奖号码
- ✅ **透明公开**：所有人都能看到相同的中奖号码
- ✅ **去中心化**：任何人都可以独立验证

**实现方式：**
- 使用 `publicDecrypt` 函数进行公开解密
- 无需用户签名或授权
- 解密结果保存在 localStorage 供所有用户查看
- 确保开奖结果的透明性和公平性

## 🚀 快速开始

### 安装依赖

```bash
cd Lottery/frontend-react
npm install
```

### 启动开发服务器

```bash
npm run dev
```

应用会在 `http://localhost:3000` 打开

### 构建生产版本

```bash
npm run build
npm run preview
```

## 📋 使用流程

### 步骤 1: 连接钱包

1. 点击右上角的 "Connect Wallet" 按钮
2. MetaMask 会弹出连接请求
3. 确认连接并切换到 Sepolia 测试网
4. 连接成功后会显示你的地址和余额

### 步骤 2: 购买彩票

1. **选择主号码**：从 0-31 中选择 5 个数字
2. **选择奖号**：从 0-9 中选择 2 个数字
3. 点击 "Buy Ticket" 按钮
4. 等待加密过程（使用 FHEVM 加密你的号码）
5. 确认 MetaMask 交易（支付 0.001 ETH）
6. 等待交易确认

**购买成功后：**
- 你的号码会自动保存到本地
- 在 "My Tickets" 部分可以看到你的彩票
- 你的号码只有你能看到（隐私保护）

### 步骤 3: 查看我的彩票

在 "My Tickets" 部分：
- 📝 查看你购买的所有彩票
- 👁️ 看到自己的号码（明文显示）
- 🔐 其他人看不到你的号码
- ⏳ 查看彩票状态（等待开奖/已开奖）

**如果已开奖：**
- 点击 "Check Prize" 按钮
- 系统会使用用户解密（User Decryption）
- 需要签名授权
- 查看你是否中奖

### 步骤 4: 查看开奖历史

在 "Draw History" 部分：
1. 点击 "Load History" 加载历史记录
2. 看到所有开奖记录
3. 点击 "Decrypt Winning Numbers" 解密中奖号码
4. 等待 10-30 秒（公开解密过程）
5. 查看本期中奖号码（所有人都能看到）

## 🔐 加密解密技术详解

### 加密输入 (Encrypted Input)

购买彩票时使用：

```javascript
// 创建加密输入缓冲区
const buffer = fhevmInstance.createEncryptedInput(
  contractAddress,  // 合约地址
  userAddress       // 用户地址
);

// 添加 7 个 euint8 数字（5个主号码 + 2个奖号）
numbers.forEach(num => buffer.add8(BigInt(num)));

// 加密并上传到 Relayer
const encryptedData = await buffer.encrypt();

// 获得加密句柄和证明
// encryptedData.handles - 密文句柄数组
// encryptedData.inputProof - 输入证明
```

### 用户解密 (User Decryption)

查看私人数据时使用（如中奖等级）：

```javascript
// 1. 生成密钥对
const keypair = fhevmInstance.generateKeypair();

// 2. 创建 EIP712 签名消息
const eip712 = fhevmInstance.createEIP712(
  keypair.publicKey,
  [contractAddress],
  startTimestamp,
  durationDays
);

// 3. 用户签名授权
const signature = await signer.signTypedData(
  eip712.domain,
  eip712.types,
  eip712.message
);

// 4. 解密数据
const result = await fhevmInstance.userDecrypt(
  handleContractPairs,
  keypair.privateKey,
  keypair.publicKey,
  signature,
  [contractAddress],
  userAddress,
  startTimestamp,
  durationDays
);
```

**特点：**
- ✅ 需要用户签名授权
- ✅ 只有授权用户能解密
- ✅ 保护隐私数据
- ✅ 无法被他人解密

### 公开解密 (Public Decryption)

查看公开数据时使用（如中奖号码）：

```javascript
// 获取加密的中奖号码
const winningNumbers = await contract.getWinningNumbers();

// 提取密文句柄
const handles = [
  winningNumbers.num1,
  winningNumbers.num2,
  winningNumbers.num3,
  winningNumbers.num4,
  winningNumbers.num5,
  winningNumbers.bonus1,
  winningNumbers.bonus2
];

// 公开解密（无需授权）
const result = await fhevmInstance.publicDecrypt(handles);

// 获取明文值
const decryptedValues = handles.map(handle => parseInt(result[handle]));
```

**特点：**
- ✅ 无需用户签名
- ✅ 任何人都能解密
- ✅ 确保透明性
- ✅ 所有人看到相同结果

## 🗂️ 项目结构

```
frontend-react/
├── src/
│   ├── components/           # React 组件
│   │   ├── Header.jsx        # 头部（钱包连接）
│   │   ├── StatusCards.jsx   # 状态卡片
│   │   ├── BuyTicket.jsx     # 购买彩票（加密输入）
│   │   ├── MyTickets.jsx     # 我的彩票（用户解密）
│   │   ├── DrawHistory.jsx   # 开奖历史（公开解密）
│   │   ├── LoadingOverlay.jsx # 加载覆层
│   │   └── Notification.jsx  # 通知组件
│   ├── hooks/                # 自定义 Hooks
│   │   ├── useWallet.js      # 钱包连接
│   │   ├── useFHEVM.js       # FHEVM 初始化
│   │   └── useContract.js    # 合约交互
│   ├── contract/             # 合约 ABI
│   │   └── abi.json
│   ├── App.jsx               # 主应用组件
│   ├── main.jsx              # 入口文件
│   └── index.css             # 全局样式
├── index.html                # HTML 模板
├── vite.config.js            # Vite 配置
├── tailwind.config.js        # Tailwind 配置
└── package.json              # 依赖配置
```

## 🔧 技术栈

- **React 18** - 现代化 UI 框架
- **Vite** - 下一代前端构建工具
- **Tailwind CSS** - 实用优先的 CSS 框架
- **ethers.js v6** - 以太坊库
- **@zama-fhe/relayer-sdk** - FHEVM 加密解密 SDK

## 🌐 网络配置

- **链 ID**: 11155111 (Sepolia 测试网)
- **网关链 ID**: 55815
- **Relayer URL**: https://relayer.testnet.zama.cloud
- **区块浏览器**: https://sepolia.etherscan.io
- **合约地址**: `0x002784c1e871843863Ad1086bcf73ff71284eF9c`

## 💡 核心特性

### 1. 完全隐私保护

- **购买前**：号码在你的浏览器中可见
- **购买时**：使用 FHEVM 在客户端加密
- **购买后**：链上只有密文，无人能看到明文
- **你的视图**：本地存储，只有你能看到
- **他人视图**：无法看到你的号码（隐私保护）

### 2. 透明的开奖机制

- **开奖前**：中奖号码加密存储
- **开奖后**：任何人都可以解密查看
- **公平性**：所有人看到相同的中奖号码
- **可验证**：任何人都可以独立验证

### 3. 现代化用户界面

- 📱 响应式设计，支持所有设备
- 🎨 精美的渐变色和动画效果
- ⚡ 快速流畅的交互体验
- 🔔 实时通知和状态提示

## 🐛 常见问题

### 1. FHEVM 未初始化

**问题**：点击购买按钮没反应  
**解决**：等待 FHEVM SDK 初始化完成（连接钱包后自动初始化）

### 2. 交易失败

**问题**：交易被拒绝或失败  
**解决**：
- 确认你在 Sepolia 测试网
- 确保有足够的测试 ETH
- 检查购票是否开放（buying status 显示 Open）

### 3. 无法看到彩票号码

**问题**：购买后看不到号码  
**解决**：
- 检查浏览器 localStorage 是否被禁用
- 刷新页面重新加载
- 清除浏览器缓存后重新购买

### 4. 解密失败

**问题**：解密中奖号码时出错  
**解决**：
- 确保已经开奖（hasDrawn = true）
- 检查网络连接
- 等待 Relayer 服务响应（可能需要 10-30 秒）
- 重试解密操作

## 📚 相关资源

- [Zama 协议文档](https://docs.zama.ai/protocol)
- [FHEVM Relayer SDK 指南](https://docs.zama.ai/protocol/relayer-sdk-guides/fhevm-relayer)
- [ethers.js 文档](https://docs.ethers.org/v6/)
- [React 文档](https://react.dev/)
- [Tailwind CSS 文档](https://tailwindcss.com/)

## 🤝 获取测试 ETH

访问以下水龙头获取 Sepolia 测试 ETH：
- https://sepoliafaucet.com/
- https://www.infura.io/faucet/sepolia
- https://faucet.quicknode.com/ethereum/sepolia

## 📝 许可证

MIT

---

**享受完全隐私的彩票体验！** 🎉

